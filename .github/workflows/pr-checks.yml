name: PR Checks

on:
  pull_request:
    branches:
      - main

jobs:
  # Main build and validation job - runs first
  build-and-validate:
    runs-on: ubuntu-latest
    outputs:
      cache-key: ${{ steps.cache-key.outputs.key }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: "24"
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install

      - name: Lint check
        run: |
          echo "Running lint checks..."
          # Add actual linting when configured
          # pnpm run lint

      - name: Type check
        run: |
          echo "Running type checks..."
          npx astro check

      - name: Install document conversion tools
        run: |
          sudo apt-get update
          sudo apt-get install -y pandoc weasyprint

      - name: Build project
        run: pnpm run build

      - name: Verify PDF/DOCX generation
        run: |
          echo "Checking for generated documents..."
          if [ -f "public/nanny-work-agreement.pdf" ]; then
            echo "✓ Work Agreement PDF generated successfully"
            ls -lh public/nanny-work-agreement.pdf
          else
            echo "✗ Work Agreement PDF not found"
            exit 1
          fi
          if [ -f "public/nanny-work-agreement.docx" ]; then
            echo "✓ Work Agreement DOCX generated successfully"
            ls -lh public/nanny-work-agreement.docx
          else
            echo "✗ Work Agreement DOCX not found"
            exit 1
          fi
          if [ -f "public/carmelina-ayala-cv.pdf" ]; then
            echo "✓ CV PDF generated successfully"
            ls -lh public/carmelina-ayala-cv.pdf
          else
            echo "✗ CV PDF not found"
            exit 1
          fi
          if [ -f "public/carmelina-ayala-cv.docx" ]; then
            echo "✓ CV DOCX generated successfully"
            ls -lh public/carmelina-ayala-cv.docx
          else
            echo "✗ CV DOCX not found"
            exit 1
          fi

      - name: Generate cache key
        id: cache-key
        run: echo "key=build-${{ github.sha }}-${{ github.run_id }}" >> $GITHUB_OUTPUT

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-${{ github.sha }}-${{ github.run_id }}
          path: |
            dist/
            .netlify/
            public/nanny-work-agreement.pdf
            public/nanny-work-agreement.docx
            public/carmelina-ayala-cv.pdf
            public/carmelina-ayala-cv.docx
          retention-days: 1

      - name: Build summary
        run: |
          echo "### Build Summary ✅" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Build completed successfully" >> $GITHUB_STEP_SUMMARY
          echo "- All PDF/DOCX documents generated" >> $GITHUB_STEP_SUMMARY
          echo "- Artifacts uploaded for preview deployment" >> $GITHUB_STEP_SUMMARY
